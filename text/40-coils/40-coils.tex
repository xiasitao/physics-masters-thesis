\renewcommand{\imagepath}{../40-coils/img}

\chapter{Feshbach and Gradient Field Coils}

In this chapter, the design and characterization of the coils used for creating steep magnetic gradients for the 3-dimensional magneto-optical trap and a strong homogeneous magnetic fields for tuning Feshbach resonances is presented. These coils are going to be called \textit{Feshbach coils} in this chapter.

\section{Requirements and Constraints}
In this section, all requirements and constraints in terms of field strength, geometry, stability and field curvature for the coils are elaborated. The next section describes how the coils were specified in order to fulfill these constraints. 
\todo{Would it make more sense to combine these two sections into one?}

\subsection*{Magnetic Field Strength}
The Feshbach coils serve two main purposes in the FermiQP demonstrator. On the one hand, they provide magnetic gradients on the order of \SIrange[]{1e1}{1e2}{\gauss\per\centi\meter}\footnote{Definition of the unit \href[]{https://www.youtube.com/watch?v=_3_JVVs2Kls}{Gauss}: $\SI{1}{\gauss} = \SI{1e-4}{\tesla}$} for the 3-dimensional magneto optical trap. On the other hand, they need to produce homogeneous magnetic fields for scanning over the Feshbach resonance of lithium at \SI{832}{\gauss}. A maximum field of \SI{1300}{\gauss}, created at a current of $I = \SI{400}{\ampere}$, was set as a target for the coil setup.

In order to generate these homogeneous fields, the coils are arranged in Helmholtz configuration, meaning that two equally-sized circular coils are placed on a common axis such that their distance is equal to their radius. The effective ratio of distance and radius required for homogeneous fields, however, depends on the finite size of the coils.

\subsection*{Geometry}
In order to produce the high Feshbach fields in the glass cell with reasonable currents, the radius of the coils should be kept as small as possible, and they should be placed as close to the glass cell as possible.

The coils will enclose the two objectives sitting above and below the glass cell between them. This introduces a minimum distance of around \SI{50}{\milli\meter} between the coils still allowing a few \si[]{\milli\meter} of leeway to fit the objectives between the coils. It was decided for a distance of \SI{55}{\milli\meter} between the innermost wires of the coils, not considering additional surface material on the coils. These geometrical constraints allow an estimation of the number of windings needed to attain the required \SI{1300}{\gauss} of field in Helmholtz configuration to 30, which was determined using simulations (see section~\ref{ch:simulation}).

The orientation of the coil arrangement is constraint by the requirement to drive Raman transitions on the atoms in the optical lattice with $\pi$-polarized light shone in through the objectives. $\pi$ transitions can only be driven with light having a polarization parallel to the quantization axis of the atoms, which is set by the direction of the magnetic field. Light shone in along the $z$ axis through the objectives can only be $\pi$-polarized in the $xy$ plane, constraining the direction of the magnetic field to the $xy$ plane. It was decided to align the coil arrangement axis with the $y$ axis of the experiment chamber, meaning that the two coils sit on the left and on the right of the glass cell with the coil axis passing through the trap region of the magneto-optical trap.

Figure~\ref{fig:feshbach_coil_geometry_constraints} shows the geometrical constraints on the position of the coils.

\begin{figure}
    \centering
    \includegraphics[]{\imagepath/feshbach_coil_geometry_constraints/feshbach_coil_geometry_constraints.pdf}
    \caption{Position of the Feshbach coils with respect to the glass cell and the objectives: The objectives (\SI{44}{\milli\meter} diameter) which are positioned below and above the glass cell are enclosed by the two coils, setting the minimum distance between the coils. The innermost coil wires have a distance of \SI{55}{\milli\meter}.}
    \label{fig:feshbach_coil_geometry_constraints}
\end{figure}

As the coils have many windings, thus having a significant size, and are close to the glass cell, they block a significant part of the optical access to the location of the atoms. Many laser beams and imaging signals must, however, be shot into and received from the glass cell, demanding that the coils leave open as much optical access to the glass cell as possible. Most notably, the beams of the magneto-optical trap need to enter the glass cell on the $y$ axis through the left and right surfaces, the pinning lattice beams also enter there with incidence angles of $\pm \SI{45}{\degree}$. On the short side of the glass cell, the science lattice beams enter with incidence angles of around $\pm \SI{15}{\degree}$. The available space for the coils is hence bound by these laser beams. In order to minimize the blocked optical access, a cone-shape coil geometry with parallelogram-shaped cross-section, consisting of $6 \times 5$ windings, was opted for, as depicted in figure~\ref{fig:parallelogram_cross_section}. The opening angle of the cone has been set to $\SI{45}{\degree}$ because then the Helmholtz condition of equal coil distance and radius is approximately fulfilled for every layer.
\begin{figure}
    \centering
    \includegraphics[]{\imagepath/parallelogram_cross_section/parallelogram_cross_section.pdf}
    \caption{Parallelogram-shaped cross-section of the coils for minimizing the blocked optical access into the glass cell, letting the pinning and science lattice beams pass alongside the coil (view from above): The windings layers stacked onto each other (in the coil axis direction) have radii that increase by one wire size per layer (cross-axis direction).}
    \label{fig:parallelogram_cross_section}
\end{figure}


\subsection*{Field and Temperature Stability}
The FermiQP demonstrator aims for a relative field stability of \SI{e-7}{} calling for an active stabilization mechanism. For this purpose, both coils are independently driven by two independent power supplies enabling fast switching.

Furthermore, it is important to ensure thermal stability of the coils. The electrical power $P(I) = RI^2$ dissipated in the coils with resistance $R$ shows quadratic scaling  with the driving current $I$. For an exemplary coil with \SI{10}{\milli\ohm} resistance driven with $I = \SI{400}{\ampere}$ this would amount to a dissipated power of \SI{1.6}{\kilo\watt} converted into heat. In order to transport this heat off efficiently, avoiding a critical increase of temperature, the coil must be made of hollow-core wires allowing for water-cooling. For a given maximal temperature increase $\Delta T$ of the cooling water, the cooling power of the water can be estimated as
\begin{align}
    Q_\text{cool} = c_\text{water} ~ \Delta T ~ m_\text{water} ~ v_\text{flow}
\end{align}
with the heat capacity $ c_\text{water}$ of water, the specific mass $m_\text{water}$, and the speed $v_\text{flow}$ of the cooling water flow, which depends on the applied pressure, the turbulence of the flow, and the wire geometry.

To lower the required cooling water pressure and to avoid turbulences in the cooling water stream, it was decided to separate the wire layers of the coils into pancakes of two layers each constituting separately driven water cooling circuits, as shown in figure~\ref{fig:pancake_structure}. For this the two supply lines for each pancake are placed next to each other, forming pairs of wires with current flowing in opposite directions. This has the additional advantage that the fields of the supply lines cancel out in the far-field and do not influence the magnetic field in the center of the coil arrangement.

\begin{figure}
    \centering
    \includegraphics[]{\imagepath/pancake_structure/pancake_structure.pdf}
    \caption{Cross-section of the pancake structure of the coils: Two layers of wire are combined into a so-called pancake that constitutes a single water cooling circuit. The layers have layer jump on the innermost winding where the wire hops from one layer to the other. The current in the two supply lines for each pancake is flowing in opposite directions such that the magnetic fields originating from the wire cancel out in the far-field.}
    \label{fig:pancake_structure}
\end{figure}

\subsection*{Field Curvature}\label{ch:field_curvature_definition}
When the atoms trapped in the optical lattice are exposed to the homogeneous Feshbach field, they experience an energy shift resulting from the interaction of the magnetic moment $\vec \mu$ with the field that can lead to trapping or anti-trapping effects $\vec B$~\cite{pritchard_cooling_1983,gehm_properties_2003, hagemann_setup_2020}:
\begin{align}
    E_{B, {\text{high-field seeker} \atop \text{low-field seeker}}} = \mp \vec \mu \vec B
\end{align}
where the sign of the shift depends on whether the atoms are in high- or low-field seeking states. The magnitude of the magnetic moment is $\mu \approx \mu_\text{B}$ with the Bohr magneton $\mu_\text{B} = \SI{9.27e-24}{\joule\per\tesla}$.

In the very center of the coil arrangement, the magnetic field in the Helmholtz operation mode of the coils is completely homogeneous. Realistically, however, there is a non-negligible position dependence $B(\vec r)$ of the field, stemming from the finite size of the region of interest and imperfections in positioning, aligning, and manufacturing of the coils. This leads to a position-dependent potential that the atoms are exposed to:
\begin{align}
    \hat H(\vec r) = \frac{\vec p^2}{2m} \mp \vec \mu \vec B(\vec r)
\end{align}

Assuming that the magnetic field around the center of the coil arrangement follows a paraboloid shape, in one dimension $B(q) = B_0 + a_q q^2$ with a field curvature coefficient $a$ and a spatial coordinate $q$, one can identify the magnetic potential with a quantum mechanical harmonic oscillator:
\begin{align}
    \underbrace{V_0 + \frac{1}{2}m\omega^2q^2}_{V_\text{HO}(q)} ~~~\equiv~~~ \underbrace{\mp \mu B(q) = \mp \mu B_0 \mp \mu a_q q^2}_{V_\text{magnetic}(q)}
\end{align}

Identifying the position-dependent terms, the magnetic potential can be assigned the angular trap frequency $\omega_{\vec q}$ along the $\vec q$ coordinate axis:
\begin{align}\label{eq:trap_omega_definition}
    \omega_{\vec q} = \sqrt[]{\mp\frac{2 \mu a_{\vec q}}{m}} = \sqrt[]{\mp\frac{2 \mu_\text{B} a_{\vec q}}{m}}
\end{align}
In the following, the trapping potential is considered trapping in the ${\vec q}$ direction if $\omega_{\vec q}$ is real, and anti-trapping if $\omega_{\vec q}$ is imaginary. For high-field seekers, the potential is trapping if $a_{\vec q} < 0$ and anti-trapping if $a_{\vec q} > 0$. For low-field seekers, the potential is trapping if $a_{\vec q} > 0$, and anti-trapping if $a_{\vec q} < 0$. This can be intuitively seen as high-field seekers are trapped if the field is concave and has a maximum, hence $a_{\vec q} < 0$, and the other way around for high-field seekers. Plots of exemplary trapping and anti-trapping field landscapes are shown in figure~\ref{fig:magnetic_field_curvature_examples}.

In a two-coil field, if the potential is trapping along the arrangement axis, it is anti-trapping in the cross-axis directions, and vice versa. This is due to Earnshaw's theorem~\cite{earnshaw_nature_1842} stating that a magnetic field in three dimensions has the shape of a hyperboloid, and thus cannot have a global extremum rather than a saddle point, implying that the magnetic field is curved into opposite directions on two axes. The field in the coil-axis direction is curved twice as much as in the cross-axis direction: $\frac{a_\text{on-axis}}{a_\text{cross-axis}} = -2$, hence the trap frequencies have a ratio of $\frac{|\omega_\text{on-axis}|}{|\omega_\text{cross-axis}|} = \sqrt{2}$~\cite{hagemann_setup_2020}.

Note that $a_{\vec q}$ relates to the field landscape along ${\vec q}$ as $a_{\vec q}  = \frac{1}{2} \pdv[2]{B}{q}$ which can be seen from the Taylor expansion $B(q) = \eval{B}_{0} + \eval{\pdv{B}{q}}_{0} q + \frac{1}{2} \eval{\pdv[2]{B}{q}}_{0} q^2 + \mathcal{O}(q^3)$ around $0$ identifying the second order term with $a_{\vec q} q^2$.

\begin{figure}
    \caption{Trapping and anti-trapping field landscapes for high-field seekers: If the curvature $a_q$ is negative, the atoms are trapped in the maximum of the magnetic field.}
    \label{fig:magnetic_field_curvature_examples}
\end{figure}

The design goal for the coil arrangement with regard to the field curvature is to minimize the absolute trap frequency in each direction by setting the coil distance accordingly.

\section{Simulation}\label{ch:simulation}
In order to determine the optimal specifications and to characterize the coils, a simulation python library was developed (called \textit{coil simulation library} from now on). It makes heavy use of the magnetic field library \textit{magpylib}~\cite{ortner_magpylib_2020, noauthor_magpylibmagpylib_2022} providing magnetic field vectors at arbitrary positions originating from wire loops, straight wires and permanent magnets of different shapes.

\subsection*{Modelling}
The \textit{coil simulation library} models arrangements of two or more coils sharing a common axis. The models are parameterized by the distance $d_\text{coil}$ of the coils to the center, the number $n_\text{coil}$, the radius $r_\text{coil}$, and the arrangement geometry of the windings of each coil, the spacing $w$ between the windings, the geometry of the wire, presence and length of supply lines, and the current $I_\text{coil}$ flowing in each coil and even in each winding if desired.

A coil is modelled as a set $\mathcal{L}$ of circular wire loops $L(r, y, I)$ with radius $r_i$, a center $y$ position $y$, and current $I$. As is the case for the FermiQP demonstrator, the wire loops' axes are parallel to the $y$ axis. For the $n_\text{on-axis} = 6$ on-axis windings and the $n_\text{cross-axis} = 5$ cross-axis windings, each loop $L_{ac}$ with on-axis index $a \in \{0, \ldots, n_\text{on-axis} - 1\}$ and cross-axis index $c \in \{0, \ldots n_\text{cross-axis} - 1\}$ is defined as
\begin{align}
    L_{ac} = L \left(r_\text{coil} + r_{ac}, y_\text{coil} + y_{ac}, I_\text{coil}\right)
\end{align}
with the on-axis ($y$) and radial (cross-axis) offsets
\begin{align}
    y_{ac} &= w\cdot \left(a-\frac{n_\text{on-axis}}{2} + \frac{1}{2}\right) \\
    r_{ac} &= y_{ac} \tan \eta + w \cdot \left(c - \frac{n_\text{cross-axis}}{2} + \frac{1}{2}\right)
\end{align}
where $w$ is the side length of a wire, and $\eta$ is the opening angle of the parallelogram-shaped cross-section of the coil cone ($\eta = \SI{45}{\degree}$ for the coils in the FermiQP demonstrator). Figure~\ref{fig:coil_model} visualizes how a coil is modelled as a set of wires.

This way of modelling a coil neglects the spiral shape of the coil wire as well as the jump between different on-axis layers of the coil.

\begin{figure}
    \caption{Modelling a coil as a set of wires:
    \todo[inline]{add figure}
    }
    \label{fig:coil_model}
\end{figure}

For an arrangement, the library provides the user with sketches of the arrangement, magnetic field vectors and magnitudes at arbitrary positions, plots of fields along trajectories through the arrangement, maps of the field landscape in planes in the arrangement, information about gradients and curvatures of the fields, resistances, inductances, dipole moments, $L\over R$ times, and mutually exerted mechanical forces of the coils.

The technical details of the implementation of the \textit{coil simulation library} are outlined in appendix chapter~\ref{ch:coil_simulation_library}. The following paragraphs explain how important characteristics of the coils and fields are calculated in the \textit{coil simulation library}.

\subsection*{Coil properties}
The \textit{coil simulation library} provides the following fundamental coil properties:
\paragraph{Resistance}
The resistance $R$ of a coil is determined using the specific resistance of copper of $\rho_\text{copper} = \SI{1.72e-8}{\ohm\meter}$:
\begin{align}
    R_\mathcal{L} = \frac{\rho_\text{copper} \sum\limits_{L \in \mathcal{L}} 2\pi r_L} {w^2 - A_\text{hollow}}
\end{align}
with the cross-section area $A_\text{hollow}$ of the hollow wire.

\paragraph{Inductance and L/R time} The inductance of a coil can be determined as $L = \frac{\Phi}{I}$ with the magnetic flux $\Phi = \int B \dd A$ at a current $I$~\cite{demtroder_zeitlich_2013}. In the \textit{coil simulation library}, the flux through a wire loop $L$ is approximated as $\Phi_L \approx B \cdot \pi r_L^2$ with the total magnetic field $B$. The total inductance of coil $L$ is calculated as
\begin{align}
    L_\mathcal{L} = \sum\limits_{L \in \mathcal{L}} \frac{B(y = y_L) \pi r_L^2}{I_L}
\end{align}

For calculating the self-inductance, $B$ was set to the field solely generated by the respective coil. For estimating the inductance of the coil when part of an arrangement of coils, $B$ was set to the field of the whole arrangement. This leads to higher inductances when operated in Helmholtz configuration and lower inductances when operated in gradient configuration. This in-arrangement inductances are only meaningful if the amount of current flowing in all coils is the same and coupled, and if the coils have the same geometry.\footnote{With coupled currents in the individual coils, the whole arrangement can be thought of as a single coil consisting of multiple sub-coils at different positions. The self-inductance of the arrangement is then calculated with the total magnetic field produced by all sub-coils of the arrangement, and can be though of as a sum of the individual inductances of the sub-coils.}\todo{add factor , see Demtroder 2 ch 4.3.2.2}

The time constant $\tau = \frac{L}{R}$ quantifies how fast the current in a coil with inductance $L$ and resistance $R$ can be switched by a sudden change of the applied voltage: $\Delta I(t) \propto 1-\exp \left(-\frac{t}{\tau}\right)$~\cite{demtroder_zeitlich_2013}. In the \textit{coil simulation library}, this time constant is estimated as
\begin{align}
    \tau_\mathcal{L} = \frac{L_\mathcal{L}}{R_\mathcal{L}}.
\end{align}
Using the inductance of the whole arrangement in Helmholtz configuration for $L$ increases  the estimated $\tau$, as the inductance of the whole arrangement of coils with coupled currents is higher and hence has a longer switching time. For the arrangement in gradient mode, the estimated $\tau$ is decreased as the coils' mutual inductance effects have opposite sign.\todo{Verify, does the L modelling and the conclusions for $\tau$ make sense?}

\paragraph{Dipole moment}
The magnetic dipole moment $\vec m$ of a coil determines the force $\vec F = \vec m (\vec \nabla \vec B)$ and torque $T = \vec m \times \vec B$ it experiences in a magnetic field. Furthermore, the magnetic field generated on the coil axis ($y$) by a magnetic moment $\vec m$ amounts to $\vec B = \frac{\mu_0 \vec m}{2\pi y^3}$ in the far-field ($y \gg r$). For a wire loop, it is defined as $\vec m = I \vec A$ with the coil axis vector $\vec A$ having the length of the wire loop cross-section area~\cite{demtroder_statische_2013}. In the \textit{coil simulation library}, the magnetic moment of a coil arrangement $\mathcal{A}$ is calculated as
\begin{align}
    m_\mathcal{A} = \sum\limits_{L \in \mathcal{A}} I_L \cdot \pi r_L^2.
\end{align}

\subsection*{Field properties}
The \textit{coil simulation library} provides the following properties of the field generated by an arrangement:

\paragraph{Curvature and Trap Frequency}
The field curvature $a_q$ along an axis $q$ in an arrangement, as defined in chapter~\ref{ch:field_curvature_definition}, is calculated from sampled magnetic field strength values $B_i(\vec 0 + d \cdot \vec q)$ for distances $d$ from the center along the $\vec q$ axis. In the \textit{coil simulation library}, the curvature is determined in a region of $\SI{+-2}{\milli\meter}$ around the center in \SI{200}{} steps as a default. A degree-7 polynomial $\hat B(d) = \sum\limits_{i=0}^7 c_i d^i$ is fit to the sampled data. The curvature is then the second coefficient of the fit: $a_{\vec q} = \hat c_2$.

The high-field seeker trap frequency is then calculated as (cf. equation \eqref{eq:trap_omega_definition})
\begin{align}
    f_{q, \text{high-field seeker}} = \frac{1}{2\pi}  \sqrt{\left| \frac{2 \hat c_2 \mu_\text{B}}{m_{^6\text{Li}}} \right|} (-\mathrm{sgn} \hat c_2)
\end{align}
which is then positive if the field is trapping and negative if anti-trapping for high-field seekers along $\vec q$.

\paragraph{Gradient}


\paragraph{Mechanical Force}






\section{Specification}
\begin{figure}
    \centering
    \begin{subfigure}[t]{0.45\textwidth}
        \centering
        \includegraphics[]{\imagepath/coil_geometry_specification/coil_geometry_specification.pdf}
        \caption{Coil geometry specification: The six winding layers are arranged in a parallelogram shape, with each layer having 5 windings.}
        \label{fig:coil_geometry_specification}
    \end{subfigure}
    \hspace{0.09\textwidth}
    \begin{subfigure}[t]{0.45\textwidth}
        \centering
        \includegraphics[]{\imagepath/wire_specification/wire_specification.pdf}
        \caption{Wire specification: The square copper wire has a side length of \SI{5.0}{\milli\meter}, the hollow core has a diameter of \SI{3.0}{\milli\meter}. On each side, a Kapton insulation layer of \SI{0.15}{\milli\meter} }
        \label{fig:wire_specification}
    \end{subfigure}
    \caption{Cross-section geometry and wire specification}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[]{\imagepath/single_coil_drawing/single_coil_drawing.pdf}
    \caption{Drawing of a single coil. The layer jumps connecting the two layers within each pancake sit opposite of the supply lines.} 
    \label{fig:single_coil_drawing}
\end{figure}

\section{Characterization}
\subsection*{Properties of the coils}

\subsection*{Magnetic Gradient}

\subsection*{Feshbach Field} 